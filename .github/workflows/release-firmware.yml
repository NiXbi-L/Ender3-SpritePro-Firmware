# Сборка прошивки и создание релиза при пуше тега v*
name: Release Firmware

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-pio-v1
          restore-keys: |
            ${{ runner.os }}-pip-pio-

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio/build
            .pio/libdeps
          key: ${{ runner.os }}-pio-release-v1
          restore-keys: |
            ${{ runner.os }}-pio-release-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: 'x64'

      - name: Install PlatformIO
        run: |
          pip install -U platformio
          pio upgrade --dev
          pio pkg update --global 2>/dev/null || true

      - name: Build firmware (STM32F103RE_creality)
        run: |
          set -o pipefail
          pio run -e STM32F103RE_creality -v 2>&1 | tee build.log

      - name: Prepare firmware artifact
        run: |
          echo "=== .pio/build contents ==="
          ls -laR .pio/build 2>/dev/null || true
          BIN=$(find .pio -name 'firmware-*.bin' 2>/dev/null | head -1)
          [ -z "$BIN" ] && BIN=$(find .pio -name '*.bin' 2>/dev/null | head -1)
          if [ -z "$BIN" ]; then
            echo "No .bin found. Last 100 lines of build.log:"
            tail -100 build.log
            exit 1
          fi
          cp "$BIN" firmware.bin
          echo "Using: $BIN"
          ls -la firmware.bin

      - name: Create Release and upload firmware
        run: |
          gh release create "${{ github.ref_name }}" firmware.bin \
            --title "Release ${{ github.ref_name }}" \
            --notes "Прошивка для **Ender 3** + **Sprite Pro**, без зонда (только механические концевики).
          - Плата: Creality 4.2.2 (STM32F103RET6)
          - MESH_BED_LEVELING, русский интерфейс
          - Установка: скопировать firmware.bin на SD-карту и включить принтер."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

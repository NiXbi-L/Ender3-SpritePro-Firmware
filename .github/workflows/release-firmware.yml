# Сборка прошивки и создание релиза при пуше тега v*
name: Release Firmware

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-pio-v1
          restore-keys: |
            ${{ runner.os }}-pip-pio-

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio/build
            .pio/libdeps
          key: ${{ runner.os }}-pio-release-v1
          restore-keys: |
            ${{ runner.os }}-pio-release-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: 'x64'

      - name: Install PlatformIO
        run: |
          pip install -U platformio
          pio upgrade --dev
          pio pkg update --global 2>/dev/null || true

      - name: Build firmware (STM32F103RE_creality)
        run: |
          set -o pipefail
          pio run -e STM32F103RE_creality -v 2>&1 | tee build.log

      - name: Prepare firmware artifact
        run: |
          echo "=== .pio/build contents ==="
          ls -laR .pio/build 2>/dev/null || true
          BIN=$(find .pio -name 'firmware-*.bin' 2>/dev/null | head -1)
          [ -z "$BIN" ] && BIN=$(find .pio -name '*.bin' 2>/dev/null | head -1)
          if [ -z "$BIN" ]; then
            echo "No .bin found. Last 100 lines of build.log:"
            tail -100 build.log
            exit 1
          fi
          cp "$BIN" firmware.bin
          echo "Using: $BIN"
          ls -la firmware.bin

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.ref_name }}
          path: firmware.bin

      - name: Create Release and upload firmware
        run: |
          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          BODY="Прошивка Ender 3 + Sprite Pro, без зонда. Плата 4.2.2 (STM32F103RET6). Установка: firmware.bin на SD-карту."
          AUTH="Authorization: token ${{ secrets.GITHUB_TOKEN }}"
          ACCEPT="Accept: application/vnd.github.v3+json"
          API="https://api.github.com/repos/${REPO}"
          echo "Creating release for tag $TAG"
          RESP=$(curl -s -w "\n%{http_code}" -X POST -H "$AUTH" -H "$ACCEPT" \
            "${API}/releases" -d "{\"tag_name\":\"${TAG}\",\"name\":\"Release ${TAG}\",\"body\":\"${BODY}\"}")
          HTTP_BODY=$(echo "$RESP" | head -n -1)
          HTTP_CODE=$(echo "$RESP" | tail -n 1)
          echo "Create release response code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "201" ]; then
            UPLOAD_URL=$(echo "$HTTP_BODY" | jq -r '.upload_url' | sed 's/{?name,label}$//')
          elif [ "$HTTP_CODE" = "422" ]; then
            echo "Release exists, fetching upload_url..."
            HTTP_BODY=$(curl -s -H "$AUTH" -H "$ACCEPT" "${API}/releases/tags/${TAG}")
            UPLOAD_URL=$(echo "$HTTP_BODY" | jq -r '.upload_url' | sed 's/{?name,label}$//')
          else
            echo "$HTTP_BODY" | jq . 2>/dev/null || echo "$HTTP_BODY"
            exit 1
          fi
          echo "Uploading firmware.bin"
          UPLOAD_RESP=$(curl -s -w "\n%{http_code}" -X POST -H "$AUTH" -H "$ACCEPT" \
            -H "Content-Type: application/octet-stream" --data-binary @firmware.bin \
            "${UPLOAD_URL}?name=firmware.bin")
          UPLOAD_CODE=$(echo "$UPLOAD_RESP" | tail -n 1)
          echo "Upload response code: $UPLOAD_CODE"
          if [ "$UPLOAD_CODE" != "201" ]; then
            echo "$UPLOAD_RESP" | head -n -1 | jq . 2>/dev/null || true
            exit 1
          fi
          echo "Release ready: https://github.com/${REPO}/releases/tag/${TAG}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
